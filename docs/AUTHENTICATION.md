# Authentication System

## Resumen

Se ha implementado un sistema completo de autenticaci√≥n con inicio de sesi√≥n, almacenamiento seguro de tokens y autorizaci√≥n autom√°tica en todas las peticiones HTTP.

## Endpoint de Autenticaci√≥n

### Login

**POST** `http://localhost:5131/api/auth/login/account`

**Request:**
```json
{
  "username": "admin",
  "password": "123456789",
  "companyCode": "chikos_pizza"
}
```

**Response (Success):**
```json
{
  "success": true,
  "message": "Sign in successfully",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIs...",
    "expiresAt": "2025-10-17T18:07:05.2564436Z",
    "refreshToken": "GKdEScA5Wtag7vH9rtbt8L5ZUHvuhTHOC9BVqtad2K4=",
    "firstName": "Administrador",
    "lastName": "Chikos"
  }
}
```

## Arquitectura

### 1. Domain Layer

#### Entities
- **`User`** (`lib/domain/entities/user.dart`)
  - `userId`: String
  - `username`: String
  - `companyCode`: String
  - `firstName`: String
  - `lastName`: String
  - `accessToken`: String
  - `refreshToken`: String
  - `expiresAt`: DateTime

#### Repositories (Interfaces)
- **`AuthRepository`** (`lib/domain/repositories/auth_repository.dart`)
  - `login(username, password, companyCode)`: Future<User>
  - `getCurrentUser()`: Future<User?>
  - `isLoggedIn()`: bool
  - `logout()`: Future<bool>

#### Use Cases
- **`LoginUser`** - Iniciar sesi√≥n
- **`GetCurrentUser`** - Obtener usuario actual
- **`LogoutUser`** - Cerrar sesi√≥n

### 2. Data Layer

#### Models
- **`LoginRequest`** - Request body para login
- **`LoginResponse`** - Response del API
- **`LoginData`** - Datos de login en response
- **`UserModel`** - Modelo persistible del usuario

#### Data Sources

**Remote:**
- **`AuthRemoteDataSource`** (`lib/data/datasources/remote/auth_remote_datasource.dart`)
  - Consume el API de autenticaci√≥n
  - Maneja errores HTTP

**Local:**
- **`AuthLocalDataSource`** (`lib/data/datasources/local/auth_local_datasource.dart`)
  - Guarda/lee usuario de SharedPreferences
  - Gestiona el estado de login

#### Repository Implementation
- **`AuthRepositoryImpl`** 
  - Coordina datasources remote y local
  - Extrae userId del JWT token
  - Guarda datos despu√©s de login exitoso

### 3. Core Layer

#### Services

**`StorageService`** (`lib/core/services/storage_service.dart`)
```dart
// Guardar usuario
await storageService.saveUser(userModel);

// Obtener usuario
final user = storageService.getUser();

// Obtener access token
final token = storageService.getAccessToken();

// Verificar si est√° loggeado
final isLoggedIn = storageService.isLoggedIn();

// Limpiar datos (logout)
await storageService.clearUserData();
```

**`AuthenticatedHttpClient`** (`lib/core/services/http_service.dart`)
- Extiende `http.BaseClient`
- Intercepta todas las peticiones HTTP
- A√±ade autom√°ticamente el header `Authorization: Bearer {token}`

```dart
// Uso autom√°tico - no necesitas hacer nada manualmente
final response = await authenticatedHttpClient.get(url);
// El token se agrega autom√°ticamente
```

### 4. Presentation Layer

#### Login Page
**`LoginPage`** (`lib/presentation/pages/auth/login_page.dart`)

Caracter√≠sticas:
- ‚úÖ Dise√±o moderno con gradiente
- ‚úÖ Validaci√≥n de formulario
- ‚úÖ Toggle para mostrar/ocultar contrase√±a
- ‚úÖ Loading indicator durante login
- ‚úÖ Manejo de errores con SnackBar
- ‚úÖ Navegaci√≥n a HomePage despu√©s de login exitoso

#### Home Page Updates
- ‚úÖ Muestra nombre del usuario en AppBar
- ‚úÖ Men√∫ de usuario con opci√≥n de logout
- ‚úÖ Di√°logo de confirmaci√≥n para logout
- ‚úÖ Carga usuario al iniciar

## Flujo de Autenticaci√≥n

### 1. Login Flow

```
Usuario ingresa credenciales
        ‚Üì
[LoginPage] ‚Üí loginUser(username, password, companyCode)
        ‚Üì
[LoginUser Use Case]
        ‚Üì
[AuthRepository] ‚Üí login()
        ‚Üì
[AuthRemoteDataSource] ‚Üí POST /api/auth/login/account
        ‚Üì
API Response con tokens
        ‚Üì
Extrae userId del JWT
        ‚Üì
[AuthLocalDataSource] ‚Üí saveUser()
        ‚Üì
[StorageService] ‚Üí Guarda en SharedPreferences
        - user_data
        - access_token
        - refresh_token
        - is_logged_in = true
        ‚Üì
Return User entity
        ‚Üì
[LoginPage] ‚Üí Navega a HomePage
```

### 2. Auto-Authentication Flow (App Start)

```
App inicia
    ‚Üì
main.dart ‚Üí InjectionContainer().init()
    ‚Üì
StorageService.init()
    ‚Üì
[AuthCheck Widget]
    ‚Üì
authRepository.isLoggedIn()
    ‚Üì
¬øEst√° loggeado?
    ‚îú‚îÄ S√ç ‚Üí HomePage
    ‚îî‚îÄ NO ‚Üí LoginPage
```

### 3. Authenticated Request Flow

```
App hace petici√≥n HTTP
        ‚Üì
authenticatedHttpClient.get(url)
        ‚Üì
AuthenticatedHttpClient intercepta
        ‚Üì
storageService.getAccessToken()
        ‚Üì
A√±ade header: Authorization: Bearer {token}
        ‚Üì
Env√≠a petici√≥n al servidor
```

### 4. Logout Flow

```
Usuario presiona Logout
        ‚Üì
Di√°logo de confirmaci√≥n
        ‚Üì
Usuario confirma
        ‚Üì
[LogoutUser Use Case]
        ‚Üì
[AuthRepository] ‚Üí logout()
        ‚Üì
[AuthLocalDataSource] ‚Üí clearUserData()
        ‚Üì
[StorageService] ‚Üí Limpia SharedPreferences
        - Elimina user_data
        - Elimina access_token
        - Elimina refresh_token
        - is_logged_in = false
        ‚Üì
[HomePage] ‚Üí Navega a LoginPage
```

## Almacenamiento de Datos

### SharedPreferences Keys

| Key | Tipo | Descripci√≥n |
|-----|------|-------------|
| `user_data` | JSON String | Datos completos del usuario |
| `access_token` | String | JWT access token |
| `refresh_token` | String | Refresh token |
| `is_logged_in` | bool | Estado de autenticaci√≥n |

### Ejemplo de user_data almacenado:

```json
{
  "userId": "1",
  "username": "admin",
  "companyCode": "chikos_pizza",
  "firstName": "Administrador",
  "lastName": "Chikos",
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "GKdEScA5Wtag7vH9rtbt8L5ZUHvuhTHOC9BVqtad2K4=",
  "expiresAt": "2025-10-17T18:07:05.2564436Z"
}
```

## Extracci√≥n de userId del JWT

El `userId` se extrae del payload del JWT token:

```dart
String _extractUserIdFromToken(String token) {
  final parts = token.split('.');
  final payload = parts[1];
  final normalized = base64Url.normalize(payload);
  final decoded = utf8.decode(base64Url.decode(normalized));
  final payloadMap = json.decode(decoded);
  
  return payloadMap['userId'] ?? payloadMap['sub'] ?? '1';
}
```

## Seguridad

### 1. Token Storage
- ‚úÖ Tokens guardados en SharedPreferences (seguro en Windows)
- ‚úÖ Access token y refresh token almacenados por separado
- ‚úÖ Datos encriptados por SharedPreferences nativo

### 2. Authorization Header
- ‚úÖ Formato est√°ndar: `Authorization: Bearer {token}`
- ‚úÖ A√±adido autom√°ticamente a TODAS las peticiones
- ‚úÖ No requiere intervenci√≥n manual

### 3. Token Expiration
- ‚úÖ Timestamp `expiresAt` almacenado
- ‚úÖ M√©todo `isTokenExpired` en User entity
- üöß Auto-refresh con refresh token (futuro)

## Uso en el C√≥digo

### Verificar si est√° loggeado

```dart
final container = InjectionContainer();
final isLoggedIn = container.authRepository.isLoggedIn();

if (isLoggedIn) {
  // Usuario autenticado
}
```

### Obtener usuario actual

```dart
final container = InjectionContainer();
final user = await container.getCurrentUser();

if (user != null) {
  print('Nombre: ${user.fullName}');
  print('Usuario: ${user.username}');
  print('Empresa: ${user.companyCode}');
  print('Token: ${user.accessToken}');
}
```

### Hacer peticiones autenticadas

```dart
// El cliente autenticado a√±ade el token autom√°ticamente
final container = InjectionContainer();
final response = await container.authenticatedHttpClient.get(
  Uri.parse('http://localhost:5131/api/product'),
);
```

### Cerrar sesi√≥n

```dart
final container = InjectionContainer();
await container.logoutUser();
```

## Manejo de Errores

### Errores de Login

| C√≥digo | Error | Mensaje |
|--------|-------|---------|
| 401 | Unauthorized | Usuario, contrase√±a o c√≥digo de empresa inv√°lido |
| 400 | Bad Request | Username, password and company code are required |
| 500+ | Server Error | Server error: {code} |
| Network | Connection Failed | Network error: ... |

### UI Error Display

Los errores se muestran al usuario mediante SnackBar rojo:

```dart
ScaffoldMessenger.of(context).showSnackBar(
  SnackBar(
    content: Text(errorMessage),
    backgroundColor: Colors.red,
  ),
);
```

## Pantalla de Login

### Caracter√≠sticas

- ‚úÖ **Dise√±o moderno** con gradiente de fondo
- ‚úÖ **Card elevado** con sombra
- ‚úÖ **Validaci√≥n de formulario**
  - Email v√°lido requerido
  - Password m√≠nimo 6 caracteres
- ‚úÖ **Toggle password visibility**
- ‚úÖ **Loading indicator** durante login
- ‚úÖ **Error handling** con SnackBar
- ‚úÖ **Navegaci√≥n autom√°tica** a HomePage

### Validaciones

**Email:**
- No puede estar vac√≠o
- Debe contener '@'

**Password:**
- No puede estar vac√≠o
- M√≠nimo 6 caracteres

## Pr√≥ximas Mejoras

### 1. Refresh Token
- Implementar auto-refresh cuando el access token expire
- Endpoint: POST /api/auth/refresh-token

### 2. Secure Storage
- Considerar flutter_secure_storage para mayor seguridad
- Encriptaci√≥n adicional de tokens

### 3. Biometric Auth
- Integrar huella digital/facial
- local_auth package

### 4. Remember Me
- Checkbox para recordar sesi√≥n
- Sesi√≥n persistente configurable

### 5. Password Recovery
- Pantalla de "Forgot Password"
- Email de recuperaci√≥n

## Testing

### Prueba de Login

1. Ejecuta tu API backend:
```bash
# Aseg√∫rate de que est√© corriendo en http://localhost:5131
```

2. Ejecuta la app:
```bash
flutter run -d windows
```

3. En la pantalla de login, ingresa:
   - Email: tu_email@example.com
   - Password: tu_password

4. Presiona "Sign In"

5. Verifica:
   - Navegaci√≥n a HomePage
   - Nombre de usuario en AppBar
   - SnackBar de bienvenida

### Prueba de Token en Requests

```dart
// Despu√©s de login, intenta sincronizar productos
final container = InjectionContainer();
await container.syncProducts();
// El token debe enviarse autom√°ticamente
```

### Prueba de Logout

1. Click en el √≠cono de usuario (arriba derecha)
2. Selecciona "Logout"
3. Confirma en el di√°logo
4. Verifica navegaci√≥n a LoginPage

## Estructura de Archivos

```
lib/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth_constants.dart        # Constantes de auth
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ storage_service.dart       # SharedPreferences wrapper
‚îÇ       ‚îî‚îÄ‚îÄ http_service.dart          # Authenticated HTTP client
‚îÇ
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ datasources/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ local/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth_local_datasource.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ remote/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ auth_remote_datasource.dart
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth_models.dart           # Login request/response models
‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ       ‚îî‚îÄ‚îÄ auth_repository_impl.dart
‚îÇ
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.dart                  # User entity
‚îÇ   ‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth_repository.dart       # Auth repository interface
‚îÇ   ‚îî‚îÄ‚îÄ usecases/
‚îÇ       ‚îú‚îÄ‚îÄ login_user.dart
‚îÇ       ‚îú‚îÄ‚îÄ get_current_user.dart
‚îÇ       ‚îî‚îÄ‚îÄ logout_user.dart
‚îÇ
‚îî‚îÄ‚îÄ presentation/
    ‚îî‚îÄ‚îÄ pages/
        ‚îî‚îÄ‚îÄ auth/
            ‚îî‚îÄ‚îÄ login_page.dart        # Login screen
```

## Diagrama de Componentes

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Presentation Layer             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ       LoginPage                  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ Uses Use Cases
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Domain Layer                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ LoginUser    ‚îÇ  ‚îÇ GetCurrentUser  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ LogoutUser   ‚îÇ  ‚îÇ User Entity     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ Implements Repository
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            Data Layer                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   AuthRepositoryImpl             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ       ‚îÇ                         ‚îÇ       ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Remote DS   ‚îÇ    ‚îÇ  Local DS     ‚îÇ ‚îÇ
‚îÇ  ‚îÇ (API calls) ‚îÇ    ‚îÇ (Storage)     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ               ‚îÇ
                ‚Üì               ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  API Server ‚îÇ  ‚îÇ SharedPrefs  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

**Implementaci√≥n completa de autenticaci√≥n JWT lista para producci√≥n** ‚úÖ

